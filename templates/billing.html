{% extends "base.html" %}
{% block title %}Billing{% endblock %}

{% block content %}
<h2>Billing</h2>

<!-- ================= SEARCH INPUT ================= -->
<input type="text"
       id="searchInput"
       placeholder="Type Part No or Product Name"
       autocomplete="off">

<div id="searchResults"
     style="border:1px solid #444; margin-top:6px; max-height:180px; overflow:auto;">
</div>

<!-- ================= PRODUCT INFO ================= -->
<div id="productInfo"
     style="margin:8px 0; font-weight:bold; color:#9ef;">
</div>

<!-- ================= ADD ITEM ================= -->
<form method="POST" action="/billing/add">
    <input type="hidden" name="product_id" id="productId">

    <input type="number"
           name="quantity"
           min="1"
           placeholder="Quantity"
           required>

    <button type="submit">Add Item</button>
</form>

<!-- ================= BILL ITEMS ================= -->
<table>
    <tr>
        <th>Item</th>
        <th>Qty</th>
        <th>Total</th>
    </tr>

    {% for i in bill_items %}
    <tr>
        <td>{{ i.part_name }}</td>
        <td>{{ i.qty }}</td>
        <td>₹ {{ i.total }}</td>
    </tr>
    {% endfor %}
</table>

<p><b>Grand Total:</b> ₹ {{ grand_total }}</p>

<form method="POST" action="/finalize">
    <button>Finalize Bill</button>
</form>

<!-- ================= SEARCH SCRIPT ================= -->
<script>
const input = document.getElementById("searchInput");
const results = document.getElementById("searchResults");
const info = document.getElementById("productInfo");
const pid = document.getElementById("productId");

input.addEventListener("keyup", async () => {
    const q = input.value.trim();
    results.innerHTML = "";

    if (q.length < 1) return;

    const res = await fetch(`/search-products?q=${q}`);
    const data = await res.json();

    data.forEach(p => {
        const div = document.createElement("div");
        div.style.padding = "6px";
        div.style.cursor = "pointer";
        div.style.borderBottom = "1px solid #333";

        div.innerHTML = `
            <b>${p.part_no}</b> - ${p.name}
            <span style="float:right">Stock: ${p.stock}</span>
        `;

        div.onclick = () => {
            pid.value = p.id;
            input.value = `${p.part_no} - ${p.name}`;
            info.innerHTML = `Selected: ${p.part_no} - ${p.name} (₹${p.price})`;
            results.innerHTML = "";
        };

        results.appendChild(div);
    });
});
</script>

{% endblock %}
