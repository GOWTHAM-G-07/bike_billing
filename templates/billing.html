{% extends "base.html" %}
{% block title %}Billing{% endblock %}

{% block content %}
<h2>Billing</h2>

<!-- ================= PRODUCT SEARCH ================= -->
<input type="text"
       id="search"
       placeholder="Search by Part No or Product Name"
       autocomplete="off">

<div id="results"
     style="border:1px solid #ccc; max-height:150px; overflow:auto;"></div>

<!-- ================= BILLING FORM ================= -->
<form method="POST">

    <select name="product_id" required>
        <option value="">-- Select Product --</option>
        {% for p in products %}
        <option value="{{ p[0] }}">
            {{ p[1] }} - {{ p[2] }} (Stock {{ p[4] }})
        </option>
        {% endfor %}
    </select>

    <input type="number"
           name="quantity"
           min="1"
           placeholder="Quantity"
           required>

    <button type="submit">Add Item</button>
</form>

<!-- ================= BILL ITEMS ================= -->
<table>
    <tr>
        <th>Item</th>
        <th>Qty</th>
        <th>Total</th>
    </tr>

    {% for i in bill_items %}
    <tr>
        <td>{{ i.part_name }}</td>
        <td>{{ i.qty }}</td>
        <td>₹ {{ i.total }}</td>
    </tr>
    {% endfor %}
</table>

<p><b>Grand Total:</b> ₹ {{ grand_total }}</p>

<!-- ================= FINALIZE ================= -->
<form method="POST" action="/finalize">
    <button>Finalize Bill</button>
</form>

<!-- ================= SEARCH SCRIPT ================= -->
<script>
const searchInput = document.getElementById("search");
const resultsDiv = document.getElementById("results");
const productSelect = document.querySelector("select[name='product_id']");

searchInput.addEventListener("keyup", async () => {
    const q = searchInput.value.trim();
    resultsDiv.innerHTML = "";

    if (q.length < 1) return;

    const res = await fetch(`/search-products?q=${q}`);
    const data = await res.json();

    data.forEach(p => {
        const div = document.createElement("div");
        div.style.padding = "6px";
        div.style.cursor = "pointer";
        div.innerHTML = `
            <b>${p.part_no}</b> - ${p.part_name}
            <small>(Stock: ${p.stock})</small>
        `;

        div.onclick = () => {
            productSelect.value = p.id;
            searchInput.value = `${p.part_no} - ${p.part_name}`;
            resultsDiv.innerHTML = "";
        };

        resultsDiv.appendChild(div);
    });
});
</script>

{% endblock %}
